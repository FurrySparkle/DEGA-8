import storage from "../mockLocalStorage";

// Save updated .js content to local storage
function saveTostorage(key: string, content: string) {
    storage.setItem(key, content);
  }
  let SoundData: string | null = null;

  if (typeof window !== 'undefined') {
    SoundData = storage.getItem('SoundData');
  }

//.p8 Injector from GPT responses

const cartridgeTemplate = (luaCode) => `pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
${luaCode}
__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__label__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000dddddddddddddd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000dddddddddddddddd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000dddddddddddddddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddddd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000dddddddddddddddddddd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000dddddddddddddddddddd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000dddddddddddddddddddd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000dddddddddddddddddddd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddddd0000000000000ccccccccccccccccccccc00000000000000000000000000000000000000000000000000000000000
0000000000000000dddddddddddddddddd00000000000000ccccccccccccccccccccc00000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddd000000000000000ccccccccccccccccccccc00000000000000000000000000000000000000000000000000000000000
0000000000000000dddddddddddddddd0000000000000000ccccccccccccccccccccc00000000000000000000000000000000000000000000000000000000000
0000000000000000dddddddddddddd000000000000000000ccccccccccccccccccccc00000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000ccccccccccccccccc000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000ccccccccccccccccc000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000ccccccccccccccccc000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000ccccccccccccccccc000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000ccccccccccccccccc000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000ccccccccccccccccccccc000000000000000ddddddddddddd0000000000000000000000000000000
000000000000000000000000000000000000000000000000ccccccccccccccccccccc000000000000000ddddddddddddd0000000000000000000000000000000
000000000000000000000000000000000000000000000000ccccccccccccccccccccc000000000000000ddddddddddddd0000000000000000000000000000000
000000000000000000000000000000000000000000000000ccccccccccccccccccccc000000000000000ddddddddddddd0000000000000000000000000000000
000000000000000000000000000000000000000000000000ccccccccccccccccccccc00000000000ddddddddddddddddd0000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddd0000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddd0000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddd0000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddd000ddddddddd0000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddd000ddddddddd0000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddd000ddddddddd0000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddd0000000ddddd0000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddddddddddddddd0000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddddddddddddddd0000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddddddddddddddd000000000000000ccccccccccccc000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddddddddddddddd000000000000000ccccccccccccc000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddddddddddddddd000000000000000ccccccccccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccccccccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccccccccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccccccccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccccccccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccccccccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccccccccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

__sfx__
${SoundData}
`;








export function  P8Injector(GPTchoice:string){
    console.log(GPTchoice)

    
    

    const extractCode = (text: string) => {
      const match = text.match(/```([\s\S]*?)```/);
      return match ? match[1] : '';
    };
    


    const removeFirstLuaLines = (text: string): string => {
      const lines = text.split('\n');
    
      // Process the first 6 lines
      for (let i = 0; i < 6 && i < lines.length; i++) {
        if (/^\s*lua\s*$/i.test(lines[i])) {
          lines[i] = ''; // Remove the line by setting it to an empty string
        }
      }
    
      // Remove any empty lines that were set to ''
      return lines.filter(line => line.trim() !== '').join('\n');
    };

    



const LUACode  = extractCode(GPTchoice);
 console.log(LUACode);

 const ReadyP8 = removeFirstLuaLines(LUACode); 
  console.log(ReadyP8);
 setP8Code( ReadyP8);
};

 function setP8Code(newCode){
  const readyCode = cartridgeTemplate(newCode)
  console.log('P8 file is in local storage! Code>' + readyCode)
  saveTostorage("gameP8File", readyCode);
  
 handleConvert();
};









 async function handleConvert(){
   // Retrieve P8 content from local storage
const gameP8Code = storage.getItem("gameP8File");

console.log(gameP8Code);
    console.log('Handling Convert!!  PicoLUA>' + gameP8Code)
    const response = await fetch('/convertP8', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ P8code: gameP8Code }),
    });
    
    const data = await response.json();
    if(data.jsCode){
    console.log(data.jsCode);
    saveTostorage("GameConverted", data.jsCode);
    //this.emit()
    };

    
};



//Deprecated code to be moved





// let LocalP8blob

// if (gameP8Code) {
//     // Create a Blob from the JavaScript content
//     const blob = new Blob([gameP8Code], { type: "text/plain" });
//      LocalP8blob = URL.createObjectURL(blob);

    
// } else {
//     console.error("Game P8 code not found in local storage.");
// }