

import pako from 'pako';


// Save updated .js content to local storage
function saveToLocalStorage(key: string, content: string) {
    localStorage.setItem(key, content);
  }
  
  
  

//.p8 Injector from GPT responses

const cartridgeTemplate = (luaCode) => `
pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
${luaCode}
__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__label__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000dddddddddddddd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000dddddddddddddddd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000dddddddddddddddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddddd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000dddddddddddddddddddd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000dddddddddddddddddddd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000dddddddddddddddddddd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000dddddddddddddddddddd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddddd0000000000000ccccccccccccccccccccc00000000000000000000000000000000000000000000000000000000000
0000000000000000dddddddddddddddddd00000000000000ccccccccccccccccccccc00000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddd000000000000000ccccccccccccccccccccc00000000000000000000000000000000000000000000000000000000000
0000000000000000dddddddddddddddd0000000000000000ccccccccccccccccccccc00000000000000000000000000000000000000000000000000000000000
0000000000000000dddddddddddddd000000000000000000ccccccccccccccccccccc00000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000ccccccccccccccccc000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000ccccccccccccccccc000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000ccccccccccccccccc000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000ccccccccccccccccc000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000ccccccccccccccccc000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000ccccccccccccccccccccc000000000000000ddddddddddddd0000000000000000000000000000000
000000000000000000000000000000000000000000000000ccccccccccccccccccccc000000000000000ddddddddddddd0000000000000000000000000000000
000000000000000000000000000000000000000000000000ccccccccccccccccccccc000000000000000ddddddddddddd0000000000000000000000000000000
000000000000000000000000000000000000000000000000ccccccccccccccccccccc000000000000000ddddddddddddd0000000000000000000000000000000
000000000000000000000000000000000000000000000000ccccccccccccccccccccc00000000000ddddddddddddddddd0000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddd0000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddd0000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddd0000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddd000ddddddddd0000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddd000ddddddddd0000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddd000ddddddddd0000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddd0000000ddddd0000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddddddddddddddd0000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddddddddddddddd0000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddddddddddddddd000000000000000ccccccccccccc000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddddddddddddddd000000000000000ccccccccccccc000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddddddddddddddd000000000000000ccccccccccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccccccccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccccccccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccccccccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccccccccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccccccccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccccccccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

__sfx__
0007000012110000001e140000301915000000121500f150111501515017150171501b15021150000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000100001d65018150166501d5501c650215501f55023550236502365000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000200000a35005150116501365014640196201e60000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000300000875018750077501d75007750227500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00040000196501f150166501c1500c150131500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000300000000007150000001515000000061500000015150000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00030000072500d640072500a65006260056300320000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

`;




const updateGameCode = (newCode)=> {
    
      const cartridge = cartridgeTemplate(newCode);
    return cartridge;
};
export function setP8Code(newCode){
  
  const readyCode = updateGameCode(newCode)
  console.log('P8 file is in local storage!')
saveToLocalStorage("gameP8File", readyCode);
 handleConvert();
};


export function P8Injector(GPTchoice:string){//Might need work
    console.log(GPTchoice)
 const isPico8Code = (text: string) => text.includes('<code>') && text.includes('</code>');
 const extractCode = (text: string) => {
   const match = text.match(/<code>([\s\S]*?)<\/code>/);
   return match ? match[1] : '';
 };

 const GoGame = isPico8Code(GPTchoice);
 console.log(GoGame);
 const LUACode  = extractCode(GPTchoice);
 console.log(LUACode);

 const ReadyP8 = updateGameCode(LUACode)
console.log(ReadyP8);
 setP8Code( ReadyP8);
};





// Retrieve P8 content from local storage
const gameP8Code = localStorage.getItem("gameP8File");
console.log(gameP8Code);





export async function handleConvert(){
   
    console.log('Handling Convert!!  PicoLUA>' + gameP8Code)
    const response = await fetch('http://localhost:5000/convertP8', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ P8code: gameP8Code }),
    });
    
    const data = await response.json();
    if(data.jsCode){
    console.log(data.jsCode);
    localStorage.setItem('GameReady', "set");};

    
};



//Deprecated code to be moved





// let LocalP8blob

// if (gameP8Code) {
//     // Create a Blob from the JavaScript content
//     const blob = new Blob([gameP8Code], { type: "text/plain" });
//      LocalP8blob = URL.createObjectURL(blob);

    
// } else {
//     console.error("Game P8 code not found in local storage.");
// }