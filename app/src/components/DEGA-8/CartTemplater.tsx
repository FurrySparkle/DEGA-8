"use client";
import storage from "../mockLocalStorage";
import fs from "@zenfs/core";
import path from "path";
import { initFS } from "./FileSystemControlCenter";


initFS();
  let SoundData: string | null = null;

  if (typeof window !== 'undefined') {
    SoundData = storage.getItem('SoundData');
  }

//.p8 Injector from GPT responses

const cartridgeTemplate = (luaCode) => `pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
${luaCode}
__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__label__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000dddddddddddddd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000dddddddddddddddd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000dddddddddddddddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddddd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000dddddddddddddddddddd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000dddddddddddddddddddd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000dddddddddddddddddddd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000dddddddddddddddddddd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddddd0000000000000ccccccccccccccccccccc00000000000000000000000000000000000000000000000000000000000
0000000000000000dddddddddddddddddd00000000000000ccccccccccccccccccccc00000000000000000000000000000000000000000000000000000000000
0000000000000000ddddddddddddddddd000000000000000ccccccccccccccccccccc00000000000000000000000000000000000000000000000000000000000
0000000000000000dddddddddddddddd0000000000000000ccccccccccccccccccccc00000000000000000000000000000000000000000000000000000000000
0000000000000000dddddddddddddd000000000000000000ccccccccccccccccccccc00000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000ccccccccccccccccc000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000ccccccccccccccccc000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000ccccccccccccccccc000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000ccccccccccccccccc000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000ccccccccccccccccc000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000ccccccccccccccccccccc000000000000000ddddddddddddd0000000000000000000000000000000
000000000000000000000000000000000000000000000000ccccccccccccccccccccc000000000000000ddddddddddddd0000000000000000000000000000000
000000000000000000000000000000000000000000000000ccccccccccccccccccccc000000000000000ddddddddddddd0000000000000000000000000000000
000000000000000000000000000000000000000000000000ccccccccccccccccccccc000000000000000ddddddddddddd0000000000000000000000000000000
000000000000000000000000000000000000000000000000ccccccccccccccccccccc00000000000ddddddddddddddddd0000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddd0000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddd0000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddd0000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddd000ddddddddd0000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddd000ddddddddd0000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddd000ddddddddd0000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddd0000000ddddd0000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddddddddddddddd0000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddddddddddddddd0000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddddddddddddddd000000000000000ccccccccccccc000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddddddddddddddd000000000000000ccccccccccccc000
00000000000000000000000000000000000000000000000000000000000000000000000000000000ddddddddddddddddd000000000000000ccccccccccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccccccccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccccccccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccccccccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccccccccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccccccccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccccccccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc000ccccc000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

__sfx__
${SoundData}
`;

const outputPath = path.join( 'picostore', 'Pic0-8', 'degademo.js');
const PICO8_DAT_PATH = path.join(
  //serverOrigin,
  'picostore',
  'Pic0-8',
  'pico8.dat'
);




async function useConvertGame(gameP8Code: string) :Promise<boolean>{


    // Create a new worker pointing to the static file
    const worker = new Worker("/pyodideConverter.js");
const ZenDATfile = await fs.promises.readFile(PICO8_DAT_PATH)
// Post some Python code to run
worker.postMessage({ code: gameP8Code , ZenDATfile: ZenDATfile  });

const promiseResult = new Promise<boolean>((resolve, reject) => {
// Listen for messages from the worker
worker.onmessage = async (e) => {
  if (e.data.success) {
   await fs.promises.writeFile(outputPath, e.data.result, "utf8");
    console.log("Worker result:", e.data.result);
    resolve(true);
  } else {
   
    console.error("Worker error:", e.data.error);
    reject(false);  
  }

}
});

 // Wait for the promise to resolve or reject
 return await promiseResult;
};




export async function P8Injector(GPTchoice:string){
    console.log(GPTchoice)
    

    const extractCode = (text: string) => {
      const match = text.match(/```([\s\S]*?)```/);
      return match ? match[1] : '';
    };
    const removeFirstLuaLines = (text: string): string => {
      const lines = text.split('\n');
    
      // Process the first 6 lines
      for (let i = 0; i < 6 && i < lines.length; i++) {
        if (/^\s*lua\s*$/i.test(lines[i])) {
          lines[i] = ''; // Remove the line by setting it to an empty string
        }
      }
    
      // Remove any empty lines that were set to ''
      return lines.filter(line => line.trim() !== '').join('\n');
    };

const LUACode  = extractCode(GPTchoice);
 const newCode = removeFirstLuaLines(LUACode); 
  const readyCode = cartridgeTemplate(newCode);    
const isConverted = await useConvertGame(readyCode);

const blobCode =  await fs.promises.readlink(outputPath);



globalThis.gamelink =  blobCode;
if ( isConverted) {
  window.localStorage.setItem('gamelink', globalThis.gamelink);
  console.log("Game conversion successful" + globalThis.gamelink);
    const event = new Event('GameConverted');
      window.dispatchEvent(event);
}

    
};



//Deprecated code to be moved





// let LocalP8blob

// if (gameP8Code) {
//     // Create a Blob from the JavaScript content
//     const blob = new Blob([gameP8Code], { type: "text/plain" });
//      LocalP8blob = URL.createObjectURL(blob);

    
// } else {
//     console.error("Game P8 code not found in local storage.");
// }